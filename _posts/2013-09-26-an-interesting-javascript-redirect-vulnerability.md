---
layout: post
title: "An Interesting JavaScript Vulnerability"
location: "San Francisco, CA"
image: headers/california_mozy.jpg
color: 1c3982
---

{{ page.title }}
================

Earlier today, I was downloading a file, and I noticed a URL in the query string and a redirect to that URL. This immediately piqued my curiosity, so I thought I'd see if there was a vulnerability. Fortunately, there wasn't, but the difference between an exploitable vulnerability and secure code was very slim in this case.

The Code
--------

The redirect on the page I was visiting was handled via JavaScript.
The code essentially does three things:
  * Pulls the URL from the query string
  * Checks that the URL ends with an approved domain
  * Redirects the user to the URL, if the domain is in the whitelist

Here's similar code, but with a vulnerability introduced:

{% highlight javascript %}
    var queryStringURI = 'http%3A%2F%2Fwww.example.com';

    var APPROVED = [
      'example.com',
      'www.example.com'
    ];

    function getDomain(uri) {
      var parsed = uri.match(new RegExp(
          '^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([\\w\\d\\-\\u0100-\\uffff.%]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$'));
      if (parsed[1] == 'http') {
        return parsed[3];
      }
      return '';
    }

    function endsWith(str, suffix) {
      var l = str.length - suffix.length;
      return l >= 0 && str.indexOf(suffix, l) == l;
    }

    function isApproved(domain) {
      for (var i = 0; i < APPROVED.length; i++) {
        if (endsWith(domain, APPROVED[i])) {
          return true;
        }
      }
      return false;
    }

    function redirect() {
      var uri = decodeURIComponent(queryStringURI);
      var domain = getDomain(uri)
      if (isApproved(uri)) {
        window.location.href = 'http://' + domain;
      }
    }
{% endhighlight %}

The previous/next slides to be preloaded are defined by the active slide. This avoids having to keep a JavaScript object of all the slides and their order. Of course, that approach is not necessarily a bad one. It just wasn't feasible when I initially built pageShow.

{% highlight html %}
  <!-- Links, these can be hidden -->
  <div class="link-meta">
    <a href="index.html" class="prev">Previous</a>
    <a href="usage.html" class="next">Next</a>
  </div>
{% endhighlight %}

It's worth having a play around with [the demo][] or checking out the code [on GitHub][] to fully grasp what's going on behind the scenes.

[the demo]: /pageShow/ "pageShow demo"
[on GitHub]: https://github.com/MozMorris/pageShow "Fork Me!"

A Simple Carousel
-----------------

[Checkout the demo](/this-is-my-carousel/)

It's not a plugin, it's not really even configurable, but I'm using it [more][more] and [more][and more]. Check out the [source][].

[more]: http://www.clipper-teas.com/ "I made this"
[and more]: http://www.commercialwashroomsltd.co.uk/ "I also made this"
[source]: https://github.com/MozMorris/this-is-my-carousel "I should make a light box script next, that would impress Paul Irish"

Cookie Monster
--------------

I built a WordPress plugin! The WordPress plugin is probably something like a right of passage. Look, [Paul Irish has one][paul]. I've been building web sites half my life and I've finally got my own one. What does it do? It displays a fixed cookie information bar at the bottom of a WP site. Style it as you please.

No demo, but more info on [GitHub][]. 

[paul]: https://github.com/paulirish/infinite-scroll "2133 stars and counting"
[GitHub]: https://github.com/MozMorris/cookie-monster "Moz Morris on GitHub"

Gzip your JavaScript on IIS 7
-----------------------------

Just recently I've been optimising a site that's running on IIS. It's not as bad as it sounds, honest. Well I was using the [server configs][] from [H5BP][] but dev tools was still reporting that the js was uncompressed. Here's the fix for the web.config:

[server configs]: https://github.com/h5bp/server-configs "HTML5 Boilerplate Server Configuration"
[H5BP]: https://github.com/h5bp "HTML5 Boilerplate"

{% highlight xml %}
  <?xml version="1.0" encoding="UTF-8"?>
  <configuration>
    <system.webServer>
      <staticContent>
        <remove fileExtension=".js" />
        <mimeMap fileExtension=".js" mimeType="text/javascript" />
      </staticContent>
    </system.webServer>
  </configuration>
{% endhighlight %}

CakePhp Expires Behaviour
-------------------------

Don't want to display records that are past their sell by date? [No problem][]. I rely on Cake to always execute this behaviour on finds. You probably shouldn't. Good bye.

[No problem]: https://gist.github.com/MozMorris/4755451
